import {
  GoogleGenerativeAI,
  HarmCategory,
  HarmBlockThreshold,
} from "@google/generative-ai";

import fs from "fs";
import mime from "mime-types";

const apiKey = import.meta.env.VITE_GOOGLE_GEMINI_AI_API_KEY;
const genAI = new GoogleGenerativeAI(apiKey);

const model = genAI.getGenerativeModel({
  model: "gemini-1.5-flash",
  systemInstruction:
    "Final Prompt: Generate a Travel Plan for the location: Las Vegas, Clark County, Nevada, United States, for 3 days, for a couple with a cheap budget. The response should include: 1. Hotel Options List: - Hotel Name - Hotel Address - Price per night (approximate) - Hotel Image URL - Geo Coordinates (latitude, longitude) - Rating - Short Description 2. Suggested Itinerary (Day-wise): For each day, list: - Place Name - Place Description - Place Image URL - Geo Coordinates - Ticket Price (if any) - Timings - Best Time to Visit 3. Format the entire response in proper JSON format.",
});

const generationConfig = {
  temperature: 1,
  topP: 0.95,
  topK: 64,
  maxOutputTokens: 65536,
  responseModalities: [],
  responseMimeType: "application/json",
};

export const chatSession = model.startChat({
  generationConfig,
  history: [
    {
      role: "user",
      parts: [
        {
          text: "Final Prompt: Generate a Travel Plan for the location: Las Vegas, Clark County, Nevada, United States, for 3 days, for a couple with a cheap budget. The response should include: 1. Hotel Options List: - Hotel Name - Hotel Address - Price per night (approximate) - Hotel Image URL - Geo Coordinates (latitude, longitude) - Rating - Short Description 2. Suggested Itinerary (Day-wise): For each day, list: - Place Name - Place Description - Place Image URL - Geo Coordinates - Ticket Price (if any) - Timings - Best Time to Visit 3. Format the entire response in proper JSON format.",
        },
      ],
    },
    {
      role: "model",
      parts: [
        {
          text: "The user wants a 3-day travel plan for a couple visiting Las Vegas on a cheap budget.\n\nThe plan should include:\n1.  **Hotel Options:** A list of budget-friendly hotels with specific details (Name, Address, Approx. Price, Image URL, Geo Coordinates, Rating, Description).\n2.  **Suggested Itinerary:** A day-by-day plan (3 days) including places to visit, with specific details for each place (Name, Description, Image URL, Geo Coordinates, Ticket Price, Timings, Best Time to Visit).\n3.  **Format:** The entire output must be in JSON format.\n\n**Constraint Checklist & Confidence Score:**\n\n1.  **Location:** Las Vegas, Clark County, Nevada, United States - Yes\n2.  **Duration:** 3 days - Yes\n3.  **Traveler Type:** Couple - Yes\n4.  **Budget:** Cheap - Yes\n5.  **Hotel Options List:** Yes\n    *   Hotel Name: Yes\n    *   Hotel Address: Yes\n    *   Price per night (approximate): Yes\n    *   Hotel Image URL: Yes\n    *   Geo Coordinates: Yes\n    *   Rating: Yes\n    *   Short Description: Yes\n6.  **Suggested Itinerary (Day-wise):** Yes\n    *   Place Name: Yes\n    *   Place Description: Yes\n    *   Place Image URL: Yes\n    *   Geo Coordinates: Yes\n    *   Ticket Price: Yes (Specify if free/approximate)\n    *   Timings: Yes\n    *   Best Time to Visit: Yes\n7.  **JSON Format:** Yes\n\nConfidence Score: 5/5\n\n**Mental Sandbox:**\n\n*   **Hotel Selection:** I need to find hotels that are generally considered budget-friendly in Vegas. Options often include older Strip properties, Downtown hotels, or off-Strip locations. I'll aim for variety (Downtown, slightly off-Strip, maybe one older Strip). I'll need to find plausible approximate prices (Vegas prices vary wildly, so I'll state this), ratings, addresses, geo-coordinates, and representative images. Examples: Excalibur, Circus Circus, LINQ (can sometimes be budget), hotels in Downtown like El Cortez or Golden Gate, or off-Strip like Ellis Island or Tuscany Suites. I'll choose 3-4 diverse options.\n*   **Itinerary Design:** The itinerary needs to focus on free or low-cost activities suitable for a couple.\n    *   **Day 1:** Arrival, check-in, explore the South/Mid Strip. Focus on free attractions like Bellagio Fountains, Bellagio Conservatory, walking the Strip, maybe exploring affordable casinos/food courts. Perhaps a visit to the \"Welcome to Fabulous Las Vegas\" sign (free).\n    *   **Day 2:** Explore Downtown Las Vegas/Fremont Street Experience. This offers a different vibe, often cheaper drinks/food, and the free light show. Maybe visit Container Park (free entry). Could include a cheap museum option if available (e.g., Neon Museum - although not *super* cheap, it's iconic, maybe offer it as an optional splurge). Or focus purely on free exploration.\n    *   **Day 3:** Explore North Strip or focus on specific free hotel attractions (e.g., Venetian canals walk-through, Flamingo Wildlife Habitat). Maybe a final budget meal or souvenir hunt before departure. Consider adding a free nature escape if feasible (e.g., mentioning Red Rock Canyon overlook points, though transport might be a budget issue, so maybe stick to Strip/Downtown).\n*   **Data Gathering:** I'll need to search for hotel details (address, price ranges, ratings, images, coordinates) and attraction details (descriptions, images, coordinates, prices, timings). I'll use general knowledge and simulated web searches for typical prices and info. Image URLs will be placeholders or sourced from common repositories if possible (like Wikimedia Commons or hotel sites - using placeholder URLs is safer). Geo-coordinates will be looked up using mapping services. Ratings will be approximate based on common review sites. Ticket prices will be marked as \"Free\" or approximate ranges. Timings will be general operating hours.\n*   **JSON Structure:** I need a root object containing `travelPlan`. Inside `travelPlan`, there will be `locationDetails`, `duration`, `travelerProfile`, `budget`, `hotelOptions` (an array of hotel objects), and `suggestedItinerary` (an array of day objects, each containing `day` number and `activities` array). Each activity object will have the required fields.\n\n**Key Considerations for \"Cheap Budget\":**\n\n*   Prioritize free activities: Walking the Strip, Bellagio Fountains, Fremont Street Experience, hotel lobby exploration (Venetian, Bellagio Conservatory, Flamingo Habitat).\n*   Include low-cost food options: Mention food courts, happy hours, buffets (though fewer cheap ones exist now), or grocery store picnics.\n*   Hotel choices: Focus on Downtown, older Strip properties, or slightly off-Strip locations. Avoid peak season/weekend price assumptions if possible, stating prices are approximate.\n*   Transportation: Assume walking or using the Deuce bus/Monorail sparingly, not taxis/rideshares extensively.\n\n**Refinement during generation:**\n\n*   Ensure image URLs are plausible placeholders or actual URLs if easily available and permissible.\n*   Double-check coordinates are roughly correct for the locations.\n*   Add notes about price variability for hotels and potential costs like resort fees.\n*   Ensure descriptions are concise and informative.\n*   Structure the JSON correctly with proper nesting, commas, and brackets/braces.",
        },
        {
          text: '```json\n{\n  "travelPlan": {\n    "locationDetails": {\n      "city": "Las Vegas",\n      "county": "Clark County",\n      "state": "Nevada",\n      "country": "United States"\n    },\n    "duration": "3 days",\n    "travelerProfile": "Couple",\n    "budget": "Cheap",\n    "hotelOptions": [\n      {\n        "hotelName": "Excalibur Hotel & Casino",\n        "hotelAddress": "3850 S Las Vegas Blvd, Las Vegas, NV 89109, United States",\n        "pricePerNightApprox": "$30 - $100+",\n        "hotelImageUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c6/Excalibur_Hotel_Casino_Las_Vegas_2020.jpg/1280px-Excalibur_Hotel_Casino_Las_Vegas_2020.jpg",\n        "geoCoordinates": {\n          "latitude": 36.1046,\n          "longitude": -115.1745\n        },\n        "rating": "3.5/5",\n        "shortDescription": "A budget-friendly, castle-themed hotel on the South Strip, known for its affordable rooms and family-friendly \'Fun Dungeon\' arcade. Connected via tram to Luxor and Mandalay Bay. *Note: Resort fees apply and prices vary significantly.*"\n      },\n      {\n        "hotelName": "LINQ Hotel + Experience",\n        "hotelAddress": "3535 S Las Vegas Blvd, Las Vegas, NV 89109, United States",\n        "pricePerNightApprox": "$40 - $150+",\n        "hotelImageUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ab/The_LINQ_Hotel_%26_Casino%2C_Las_Vegas.jpg/1024px-The_LINQ_Hotel_%26_Casino%2C_Las_Vegas.jpg",\n        "geoCoordinates": {\n          "latitude": 36.1179,\n          "longitude": -115.1711\n        },\n        "rating": "4.0/5",\n        "shortDescription": "Centrally located on the Strip with modern, compact rooms. Offers easy access to the LINQ Promenade, High Roller observation wheel, and numerous dining options. Can have good deals, especially mid-week. *Note: Resort fees apply and prices vary significantly.*"\n      },\n      {\n        "hotelName": "Golden Nugget Las Vegas Hotel & Casino",\n        "hotelAddress": "129 E Fremont St, Las Vegas, NV 89101, United States",\n        "pricePerNightApprox": "$50 - $180+",\n        "hotelImageUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/Golden_Nugget_Hotel_%26_Casino%2C_Las_Vegas_%282017%29.jpg/1024px-Golden_Nugget_Hotel_%26_Casino%2C_Las_Vegas_%282017%29.jpg",\n        "geoCoordinates": {\n          "latitude": 36.1706,\n          "longitude": -115.1408\n        },\n        "rating": "4.0/5",\n        "shortDescription": "A more upscale option in Downtown Las Vegas on Fremont Street. Features the famous \'Tank\' pool with a waterslide through a shark tank. Often more affordable than comparable Strip hotels. *Note: Resort fees apply and prices vary significantly.*"\n      },\n      {\n        "hotelName": "Ellis Island Hotel Casino & Brewery",\n        "hotelAddress": "4178 Koval Ln, Las Vegas, NV 89109, United States",\n        "pricePerNightApprox": "$35 - $120+",\n        "hotelImageUrl": "https://ellisबाजी.com/wp-content/uploads/2021/08/ellis-island-hotel-casino-brewery-exterior-night.jpg",\n        "geoCoordinates": {\n          "latitude": 36.1153,\n          "longitude": -115.1643\n        },\n        "rating": "4.0/5",\n        "shortDescription": "Located just off the Strip (easy walk). Known for its excellent value, on-site brewery, popular karaoke bar, and cheap prime rib special. Basic but clean rooms. *Note: Resort fees may apply and prices vary significantly.*"\n      }\n    ],\n    "suggestedItinerary": [\n      {\n        "day": 1,\n        "theme": "South & Mid-Strip Exploration",\n        "activities": [\n          {\n            "placeName": "Welcome to Fabulous Las Vegas Sign",\n            "placeDescription": "Take the iconic photo with the famous sign. It\'s a classic Vegas must-do. There\'s usually a line, but it moves quickly. Parking is available.",\n            "placeImageUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/7/78/Welcome_to_Fabulous_Las_Vegas_sign.jpg/1024px-Welcome_to_Fabulous_Las_Vegas_sign.jpg",\n            "geoCoordinates": {\n              "latitude": 36.0820,\n              "longitude": -115.1728\n            },\n            "ticketPrice": "Free",\n            "timings": "24 hours",\n            "bestTimeToVisit": "Morning to avoid the worst heat and potentially shorter lines."\n          },\n          {\n            "placeName": "Walk the South & Mid-Strip",\n            "placeDescription": "Explore the unique architecture and themes of hotels like Luxor (pyramid), Excalibur (castle), New York-New York (NYC skyline), Paris (Eiffel Tower), Bellagio, and Caesars Palace. Wander through the casinos (no purchase necessary to look).",\n            "placeImageUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/b/ba/Las_Vegas_Strip_sunset_view_from_the_High_Roller.jpg/1280px-Las_Vegas_Strip_sunset_view_from_the_High_Roller.jpg",\n            "geoCoordinates": {\n              "latitude": 36.1146,\n              "longitude": -115.1728\n            },\n            "ticketPrice": "Free",\n            "timings": "24 hours",\n            "bestTimeToVisit": "Evening when the lights are on, but daytime is also interesting."\n          },\n          {\n            "placeName": "Bellagio Conservatory & Botanical Gardens",\n            "placeDescription": "Inside the Bellagio Hotel, this stunning garden features elaborate seasonal displays made entirely of flowers, plants, and trees. The theme changes several times a year.",\n            "placeImageUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/b/bf/Bellagio_Conservatory_%28Las_Vegas%29.jpg/1024px-Bellagio_Conservatory_%28Las_Vegas%29.jpg",\n            "geoCoordinates": {\n              "latitude": 36.1126,\n              "longitude": -115.1746\n            },\n            "ticketPrice": "Free",\n            "timings": "24 hours",\n            "bestTimeToVisit": "Anytime, but can be crowded during peak hours and weekends."\n          },\n          {\n            "placeName": "Fountains of Bellagio",\n            "placeDescription": "A spectacular water show synchronized to music and lights on the lake in front of the Bellagio Hotel. A must-see free attraction.",\n            "placeImageUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/7/76/Fountains_of_Bellagio_2.JPG/1280px-Fountains_of_Bellagio_2.JPG",\n            "geoCoordinates": {\n              "latitude": 36.1124,\n              "longitude": -115.1738\n            },\n            "ticketPrice": "Free",\n            "timings": "Mon-Fri: 3 PM - 7 PM (every 30 min), 7 PM - 12 AM (every 15 min). Sat-Sun: 12 PM - 7 PM (every 30 min), 7 PM - 12 AM (every 15 min). *Subject to change.",\n            "bestTimeToVisit": "Evening/Night for the best visual effects with the lights."\n          }\n        ]\n      },\n      {\n        "day": 2,\n        "theme": "Downtown & Fremont Street Fun",\n        "activities": [\n          {\n            "placeName": "Fremont Street Experience",\n            "placeDescription": "A pedestrian mall in Downtown Las Vegas featuring vintage casinos, street performers, cheaper drinks/food, and the famous Viva Vision light show on the overhead canopy.",\n            "placeImageUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/Fremont_Street_Experience%2C_Las_Vegas%2C_NV_%28110741837%29.jpeg/1280px-Fremont_Street_Experience%2C_Las_Vegas%2C_NV_%28110741837%29.jpeg",\n            "geoCoordinates": {\n              "latitude": 36.1700,\n              "longitude": -115.1409\n            },\n            "ticketPrice": "Free (Viva Vision show is free; SlotZilla zipline costs extra)",\n            "timings": "Street accessible 24 hours; Viva Vision shows typically run hourly from 6 PM to 2 AM.",\n            "bestTimeToVisit": "Evening/Night for the Viva Vision show and vibrant atmosphere."\n          },\n          {\n            "placeName": "Downtown Container Park",\n            "placeDescription": "An open-air shopping center and park built from shipping containers. Features boutique shops, unique food spots, live music, and a playground with a giant praying mantis sculpture that shoots fire at night.",\n            "placeImageUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b9/Downtown_Container_Park_%2834216326906%29.jpg/1024px-Downtown_Container_Park_%2834216326906%29.jpg",\n            "geoCoordinates": {\n              "latitude": 36.1672,\n              "longitude": -115.1356\n            },\n            "ticketPrice": "Free entry (Food/drinks/shopping extra)",\n            "timings": "Varies by shop/restaurant, generally open late morning until late evening/night. Check official website.",\n            "bestTimeToVisit": "Late afternoon or evening."\n          },\n          {\n            "placeName": "Explore Vintage Casinos",\n            "placeDescription": "Wander through historic downtown casinos like Golden Nugget, Binion\'s, Four Queens, and El Cortez. Experience the \'Old Vegas\' vibe, often find lower table limits (if gambling), and see attractions like the Hand of Faith nugget at Golden Nugget.",\n            "placeImageUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Golden_Gate_Casino_Front_-_Las_Vegas.jpg/1024px-Golden_Gate_Casino_Front_-_Las_Vegas.jpg",\n            "geoCoordinates": {\n              "latitude": 36.1706,\n              "longitude": -115.1435\n            },\n            "ticketPrice": "Free to enter",\n            "timings": "24 hours",\n            "bestTimeToVisit": "Anytime, but livelier in the evening."\n          }\n        ]\n      },\n      {\n        "day": 3,\n        "theme": "North Strip & Unique Freebies",\n        "activities": [\n          {\n            "placeName": "Flamingo Wildlife Habitat",\n            "placeDescription": "Located at the Flamingo Hotel, this free attraction is a serene oasis featuring Chilean flamingos, ducks, swans, turtles, and koi fish amidst lush foliage and waterfalls.",\n            "placeImageUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/Flamingo_Las_Vegas_Wildlife_Habitat.jpg/1024px-Flamingo_Las_Vegas_Wildlife_Habitat.jpg",\n            "geoCoordinates": {\n              "latitude": 36.1167,\n              "longitude": -115.1707\n            },\n            "ticketPrice": "Free",\n            "timings": "Typically 7 AM - 8 PM (check current hours)",\n            "bestTimeToVisit": "Daytime, especially morning when animals might be more active."\n          },\n          {\n            "placeName": "The Venetian & The Palazzo",\n            "placeDescription": "Walk through the stunning recreation of Venice, complete with canals (gondola rides cost extra but watching is free), St. Mark\'s Square, and high-end shops under a painted sky ceiling. The Palazzo connects via an indoor walkway.",\n            "placeImageUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/f/ff/Canal_in_the_Venetian_Hotel%2C_Las_Vegas.JPG/1280px-Canal_in_the_Venetian_Hotel%2C_Las_Vegas.JPG",\n            "geoCoordinates": {\n              "latitude": 36.1244,\n              "longitude": -115.1717\n            },\n            "ticketPrice": "Free to explore (Gondola rides extra)",\n            "timings": "24 hours (shops have specific hours)",\n            "bestTimeToVisit": "Anytime."\n          },\n          {\n            "placeName": "Mirage Volcano",\n            "placeDescription": "Another iconic free Strip show. Watch the volcano erupt with fireballs, water effects, and a soundtrack in front of The Mirage hotel.",\n            "placeImageUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/3/34/Mirage_volcano_eruption.jpg/1280px-Mirage_volcano_eruption.jpg",\n            "geoCoordinates": {\n              "latitude": 36.1214,\n              "longitude": -115.1741\n            },\n            "ticketPrice": "Free",\n            "timings": "Shows typically run nightly on the hour from 7 PM to 11 PM (check current schedule, as it can vary or be suspended).",\n            "bestTimeToVisit": "Evening/Night."\n          },\n          {\n            "placeName": "Budget Bites & Souvenirs",\n            "placeDescription": "Grab an affordable lunch from a food court (e.g., Cosmopolitan\'s Block 16, Fashion Show Mall) or find happy hour deals. Look for cheap souvenirs in shops like Bonanza Gift Shop (\'World\'s Largest Gift Shop\') or ABC Stores.",\n            "placeImageUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/4/4d/Bonanza_Gifts_-_World%27s_Largest_Gift_Shop_-_Las_Vegas.jpg/1024px-Bonanza_Gifts_-_World%27s_Largest_Gift_Shop_-_Las_Vegas.jpg",\n            "geoCoordinates": {\n              "latitude": 36.1331,\n              "longitude": -115.1645\n            },\n            "ticketPrice": "Cost of food/souvenirs varies",\n            "timings": "Varies by establishment",\n            "bestTimeToVisit": "Anytime, check specific venue hours."\n          }\n        ]\n      }\n    ],\n    "notes": "This plan focuses on free and low-cost activities. Transportation costs (Deuce bus, walking, potentially limited rideshare) should be factored into the budget. Food costs can be managed by utilizing food courts, happy hours, downtown eateries, or convenience stores. Hotel prices are highly variable based on dates (weekends/holidays/conventions are much more expensive) and do not include mandatory resort fees (typically $30-$50+ per night) or taxes. Always check current prices, timings, and show schedules before visiting."\n  }\n}\n```',
        },
      ],
    },
  ],
});

async function generateTravelPlan() {
  try {
    const response = await chatSession.generateMessage();
    const rawOutput = response.text;
    console.log("Raw model output:", rawOutput);

    let travelPlanData;
    try {
      travelPlanData = JSON.parse(rawOutput);
    } catch (err) {
      console.error("Error parsing JSON from model output:", err);
      return;
    }

    console.log("Parsed travel plan:", travelPlanData.travelPlan);
    return travelPlanData.travelPlan;
  } catch (error) {
    console.error("Error generating travel plan:", error);
  }
}

generateTravelPlan();
